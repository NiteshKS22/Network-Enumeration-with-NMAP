
# DNS Overview

## What is DNS?
Domain Name System (DNS) is an integral part of the Internet. For example, through domain names, such as academy.hackthebox.com or www.hackthebox.com, we can reach the web servers that the hosting provider has assigned one or more specific IP addresses. DNS is a system for resolving computer names into IP addresses, and it does not have a central database. Simplified, we can imagine it like a library with many different phone books. The information is distributed over many thousands of name servers. Globally distributed DNS servers translate domain names into IP addresses and thus control which server a user can reach via a particular domain.

There are several types of DNS servers that are used worldwide:

- DNS root server
- Authoritative name server
- Non-authoritative name server
- Caching server
- Forwarding server
- Resolver

### DNS Root Server
The root servers of the DNS are responsible for the top-level domains (TLD). As the last instance, they are only requested if the name server does not respond. Thus, a root server is a central interface between users and content on the Internet, as it links domain and IP address. The Internet Corporation for Assigned Names and Numbers (ICANN) coordinates the work of the root name servers. There are 13 such root servers around the globe.

### Authoritative Nameserver
Authoritative name servers hold authority for a particular zone. They only answer queries from their area of responsibility, and their information is binding. If an authoritative name server cannot answer a client's query, the root name server takes over at that point. Based on the country, company, etc., authoritative nameservers provide answers to recursive DNS nameservers, assisting in finding the specific web server(s).

### Non-authoritative Nameserver
Non-authoritative name servers are not responsible for a particular DNS zone. Instead, they collect information on specific DNS zones themselves, which is done using recursive or iterative DNS querying.

### Caching DNS Server
Caching DNS servers cache information from other name servers for a specified period. The authoritative name server determines the duration of this storage.

### Forwarding Server
Forwarding servers perform only one function: they forward DNS queries to another DNS server.

### Resolver
Resolvers are not authoritative DNS servers but perform name resolution locally in the computer or router.

### DNS Encryption
DNS is mainly unencrypted. Devices on the local WLAN and Internet providers can therefore hack in and spy on DNS queries. Since this poses a privacy risk, there are now some solutions for DNS encryption. By default, IT security professionals apply DNS over TLS (DoT) or DNS over HTTPS (DoH) here. In addition, the network protocol DNSCrypt also encrypts the traffic between the computer and the name server.

## DNS Records

Different DNS records are used for the DNS queries, which all have various tasks. Moreover, separate entries exist for different functions since we can set up mail servers and other servers for a domain.

### Types of DNS Records
- **A**: Returns an IPv4 address of the requested domain as a result.
- **AAAA**: Returns an IPv6 address of the requested domain.
- **MX**: Returns the responsible mail servers as a result.
- **NS**: Returns the DNS servers (nameservers) of the domain.
- **TXT**: This record can contain various information such as SPF, DMARC, Google Search Console verification, and SSL certificates.
- **CNAME**: Serves as an alias for another domain name.
- **PTR**: Reverse lookup, converting IP addresses into valid domain names.
- **SOA**: Provides information about the corresponding DNS zone and administrative contact email.

### Example DNS Query (SOA)
```
dig any inlanefreight.htb @10.129.14.128

; <<>> DiG 9.16.1-Ubuntu <<>> any inlanefreight.htb @10.129.14.128
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 7649
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 064b7e1f091b95120100000061476865a6026d01f87d10ca (good)
;; QUESTION SECTION:
;inlanefreight.htb.             IN      ANY

;; ANSWER SECTION:
inlanefreight.htb.      604800  IN      TXT     "v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip4:10.129.124.8 ip4:10.129.127.2 ip4:10.129.42.106 ~all"
inlanefreight.htb.      604800  IN      TXT     "atlassian-domain-verification=t1rKCy68JFszSdCKVpw64A1QksWdXuYFUeSXKU"
inlanefreight.htb.      604800  IN      TXT     "MS=ms97310371"
inlanefreight.htb.      604800  IN      SOA     inlanefreight.htb. root.inlanefreight.htb. 2 604800 86400 2419200 604800
inlanefreight.htb.      604800  IN      NS      ns.inlanefreight.htb.

;; ADDITIONAL SECTION:
ns.inlanefreight.htb.   604800  IN      A       10.129.34.136

;; Query time: 0 msec
;; SERVER: 10.129.14.128#53(10.129.14.128)
;; WHEN: So Sep 19 18:42:13 CEST 2021
;; MSG SIZE  rcvd: 437
```
Zone transfer refers to the transfer of zones to another server in DNS, which generally happens over TCP port 53. This procedure is abbreviated Asynchronous Full Transfer Zone (AXFR). Since a DNS failure usually has severe consequences for a company, the zone file is almost invariably kept identical on several name servers. When changes are made, it must be ensured that all servers have the same data. Synchronization between the servers involved is realized by zone transfer. Using a secret key rndc-key, which we have seen initially in the default configuration, the servers make sure that they communicate with their own master or slave. Zone transfer involves the mere transfer of files or records and the detection of discrepancies in the data sets of the servers involved.

The original data of a zone is located on a DNS server, which is called the primary name server for this zone. However, to increase the reliability, realize a simple load distribution, or protect the primary from attacks, one or more additional servers are installed in practice in almost all cases, which are called secondary name servers for this zone. For some Top-Level Domains (TLDs), making zone files for the Second Level Domains accessible on at least two servers is mandatory.

DNS entries are generally only created, modified, or deleted on the primary. This can be done by manually editing the relevant zone file or automatically by a dynamic update from a database. A DNS server that serves as a direct source for synchronizing a zone file is called a master. A DNS server that obtains zone data from a master is called a slave. A primary is always a master, while a secondary can be both a slave and a master.

The slave fetches the SOA record of the relevant zone from the master at certain intervals, the so-called refresh time, usually one hour, and compares the serial numbers. If the serial number of the SOA record of the master is greater than that of the slave, the data sets no longer match.

## DNS Configuration

There are many different configuration types for DNS. Therefore, we will only discuss the most important ones to illustrate better the functional principle from an administrative point of view.

### Configuration Files:
1. **named.conf.local**: Local DNS configuration.
2. **named.conf.options**: Contains server-specific configuration.
3. **named.conf.log**: Used for logging purposes.

### Zone Files
Zone files are text files that describe a DNS zone. It contains records like SOA, NS, and A, and provides essential details for proper DNS resolution.

### Reverse Name Resolution
The reverse lookup file maps IP addresses back to Fully Qualified Domain Names (FQDNs) using PTR records.

## Dangerous Settings

There are several dangerous settings that may lead to vulnerabilities in DNS servers. Misconfigurations can result in attacks or improper functioning of the DNS service.

### Risky Configuration Options
- **allow-query**: Defines which hosts are allowed to send requests to the DNS server.
- **allow-recursion**: Defines which hosts are allowed to send recursive requests to the DNS server.
- **allow-transfer**: Defines which hosts are allowed to receive zone transfers from the DNS server.

## Footprinting the Service

Footprinting is the process of gathering information from a DNS server about other name servers, records, and possible vulnerabilities. This can be done by querying NS, AXFR, and other DNS records.

### DNS Query for NS Records
```
$ dig ns inlanefreight.htb @10.129.14.128
```

### Zone Transfer Query (AXFR)
```
NiteshKS22@htb[/htb]$ dig axfr inlanefreight.htb @10.129.14.128

; <<>> DiG 9.16.1-Ubuntu <<>> axfr inlanefreight.htb @10.129.14.128
;; global options: +cmd
inlanefreight.htb.      604800  IN      SOA     inlanefreight.htb. root.inlanefreight.htb. 2 604800 86400 2419200 604800
inlanefreight.htb.      604800  IN      TXT     "MS=ms97310371"
inlanefreight.htb.      604800  IN      TXT     "atlassian-domain-verification=t1rKCy68JFszSdCKVpw64A1QksWdXuYFUeSXKU"
inlanefreight.htb.      604800  IN      TXT     "v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip4:10.129.124.8 ip4:10.129.127.2 ip4:10.129.42.106 ~all"
inlanefreight.htb.      604800  IN      NS      ns.inlanefreight.htb.
app.inlanefreight.htb.  604800  IN      A       10.129.18.15
internal.inlanefreight.htb. 604800 IN   A       10.129.1.6
mail1.inlanefreight.htb. 604800 IN      A       10.129.18.201
ns.inlanefreight.htb.   604800  IN      A       10.129.34.136
inlanefreight.htb.      604800  IN      SOA     inlanefreight.htb. root.inlanefreight.htb. 2 604800 86400 2419200 604800
;; Query time: 4 msec
;; SERVER: 10.129.14.128#53(10.129.14.128)
;; WHEN: So Sep 19 18:51:19 CEST 2021
;; XFR size: 9 records (messages 1, bytes 520)
```

### DIG ZONE TRANSFER - INTERNAL
```
NiteshKS22@htb[/htb]$ dig axfr internal.inlanefreight.htb @10.129.14.128

; <<>> DiG 9.16.1-Ubuntu <<>> axfr internal.inlanefreight.htb @10.129.14.128
;; global options: +cmd
internal.inlanefreight.htb. 604800 IN   SOA     inlanefreight.htb. root.inlanefreight.htb. 2 604800 86400 2419200 604800
internal.inlanefreight.htb. 604800 IN   TXT     "MS=ms97310371"
internal.inlanefreight.htb. 604800 IN   TXT     "atlassian-domain-verification=t1rKCy68JFszSdCKVpw64A1QksWdXuYFUeSXKU"
internal.inlanefreight.htb. 604800 IN   TXT     "v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip4:10.129.124.8 ip4:10.129.127.2 ip4:10.129.42.106 ~all"
internal.inlanefreight.htb. 604800 IN   NS      ns.inlanefreight.htb.
dc1.internal.inlanefreight.htb. 604800 IN A     10.129.34.16
dc2.internal.inlanefreight.htb. 604800 IN A     10.129.34.11
mail1.internal.inlanefreight.htb. 604800 IN A   10.129.18.200
ns.internal.inlanefreight.htb. 604800 IN A      10.129.34.136
vpn.internal.inlanefreight.htb. 604800 IN A     10.129.1.6
ws1.internal.inlanefreight.htb. 604800 IN A     10.129.1.34
ws2.internal.inlanefreight.htb. 604800 IN A     10.129.1.35
wsus.internal.inlanefreight.htb. 604800 IN A    10.129.18.2
internal.inlanefreight.htb. 604800 IN   SOA     inlanefreight.htb. root.inlanefreight.htb. 2 604800 86400 2419200 604800
;; Query time: 0 msec
;; SERVER: 10.129.14.128#53(10.129.14.128)
;; WHEN: So Sep 19 18:53:11 CEST 2021
;; XFR size: 15 records (messages 1, bytes 664)
```

### Brute Forcing Subdomains
Brute-forcing subdomains can help discover additional DNS records that may exist on the server. The process can be done with various tools, like DNSenum, or by using a list of subdomains from SecLists.

### Example Brute-Force Command
```
$ for sub in $(cat /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt); do dig $sub.inlanefreight.htb @10.129.14.128 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt; done
```

## DNS Server Security Tools

Several tools can be used to assess the security of DNS servers, including DNSenum and others for brute-force attacks and zone transfer checks.

### Using DNSenum
```
$ dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb
```


## QUESTIONS

**1.  Interact with the target DNS using its IP address and enumerate the FQDN of it for the "inlanefreight.htb" domain.**

```
dig inlanefright.htb
```

**2.  Identify if its possible to perform a zone transfer and submit the TXT record as the answer. (Format: HTB{...})**

```
dig axfr inlanefright.htb @IP

> u will get TXT once

dig axfr different_TXT_Subdomain.inlanefright.htb @IP

> u will get answer
```

**3.  What is the IPv4 address of the hostname DC1?**

```
u will get answer from previous cmd
```

**4.  What is the FQDN of the host where the last octet ends with "x.x.x.203"?**

For this I have written an script

```
#!/bin/bash

# Define DNS server
dnsserver="10.129.42.195"

# Define the subdomains to scan
subdomains=(
    "ns.inlanefreight.htb"
    "app.inlanefreight.htb"
    "dev.inlanefreight.htb"
    "internal.inlanefreight.htb"
)

# Define the output directory and create it if it doesn't exist
output_dir="./subdomain_results"
mkdir -p "$output_dir"

# List of subdomain files to test
subdomain_files=(
    "/opt/useful/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt"
    "/opt/useful/seclists/Discovery/DNS/italian-subdomains.txt"
    "/opt/useful/seclists/Discovery/DNS/subdomains-spanish.txt"
    "/opt/useful/seclists/Discovery/DNS/bug-bounty-program-subdomains-trickest-inventory.txt"
    "/opt/useful/seclists/Discovery/DNS/n0kovo_subdomains.txt"
    "/opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt"
    "/opt/useful/seclists/Discovery/DNS/combined_subdomains.txt"
    "/opt/useful/seclists/Discovery/DNS/namelist.txt"
    "/opt/useful/seclists/Discovery/DNS/subdomains-top1million-20000.txt"
    "/opt/useful/seclists/Discovery/DNS/deepmagic.com-prefixes-top50000.txt"
    "/opt/useful/seclists/Discovery/DNS/deepmagic.com-prefixes-top500.txt"
    "/opt/useful/seclists/Discovery/DNS/dns-Jhaddix.txt"
    "/opt/useful/seclists/Discovery/DNS/shubs-stackoverflow.txt"
    "/opt/useful/seclists/Discovery/DNS/tlds.txt"
    "/opt/useful/seclists/Discovery/DNS/dns-recon-fierce-reconng.txt"
)

# Loop through each subdomain list and run dnsenum for each subdomain
for subdomain_list in "${subdomain_files[@]}"; do
    echo "Running dnsenum for subdomains in file: $subdomain_list"
    
    # Loop through each subdomain
    for subdomain in "${subdomains[@]}"; do
        echo "Scanning subdomain: $subdomain"

        # Output file name based on subdomain and subdomain list
        output_file="$output_dir/$(basename "$subdomain_list").$(basename "$subdomain").txt"

        # Run dnsenum command for each subdomain
        dnsenum --dnsserver "$dnsserver" --enum -p 0 -s 0 -o "$output_file" -f "$subdomain_list" "$subdomain"

        # Show the output on the screen as well
        echo "Results for $subdomain saved to $output_file"
        cat "$output_file" # Display the result on screen
    done
done

echo "DNS enumeration completed for all subdomain files and subdomains."
```

```
chmod +x script.sh
```

```
./script.sh
```

```
u will get answer
```
