## FTP

The File Transfer Protocol (FTP) is one of the oldest protocols on the Internet, runs within the application layer of the TCP/IP protocol stack. Thus, it is on the same layer as HTTP or POP. and also work with the support of browsers or email clients to performs their services.

 In an FTP connection, two channels are opened. 

 > **1. client and server establish a control channel through TCP port 21. The client sends commands to the server, and the server returns status codes**
 > **2. both communication participants can establish the data channel via TCP port 20. This channel is used exclusively for data transmission, and the protocol watches for errors during this process.**
` if Connection brokeoff the transport can be resumed after re-established contact`

# Active Vs Passive FTP

Active -  the client establishes the connection as described via `TCP port 21` and thus informs the server via which client-side port the server can transmit its responses. However, if a firewall protects the client, the server cannot reply because all external connections are blocked.
`for this purpose we use passive ftp`
passive - has been developed. Here, the server announces a port through which the client can establish the data channel. Since the client initiates the connection in this method, the firewall does not block the transfer.

FTP differt [commands](https://web.archive.org/web/20230326204635/https://www.smartfile.com/blog/the-ultimate-ftp-commands-list/) and [status code](https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes)

Usually, we need credentials to use FTP on a server. We also need to know that FTP is a `clear-text protocol` that can sometimes be sniffed if conditions on the network are right. However, there is also the possibility that a server offers anonymous FTP.

## TFTP (Trivail File Transfer Protocol)

Simpler than FTP ans perform file transfer b/w client and server process.

it doesn't provide user authentication and other features supported by FTP

`FTP uses TCP` and `TFTP uses UDP`

TFTP unlike FTP doen't requie user's authentication. It Does not support procted login via passowrds ad sets limit on access based solely on r&w permissions.

### 📄 TFTP Commands

| Command   | Description                                                                                       |
|-----------|---------------------------------------------------------------------------------------------------|
| connect   | Sets the remote host, and optionally the port, for file transfers.                                |
| get       | Transfers a file or set of files from the remote host to the local host.                          |
| put       | Transfers a file or set of files from the local host onto the remote host.                        |
| quit      | Exits tftp.                                                                                       |
| status    | Shows the current status of tftp, including the current transfer mode, connection, timeout, etc.  |
| verbose   | Toggles verbose mode to display additional info during file transfers.                            |

`Unlike FTP, TFTP does not have directory listing functionality.`

## default Configuration

Most used FTP servers on linux distro is vsFTPd. default conf. can be found `/etc.vsftpd.conf` and some setting predefined by default.

```
NiteshKS22@htb[/htb]$ cat /etc/vsftpd.conf | grep -v "#"
```

### ⚙️ vsftpd Configuration Settings

| Setting                        | Description                                                                                              |
|--------------------------------|----------------------------------------------------------------------------------------------------------|
| listen=NO                      | Run from inetd or as a standalone daemon?                                                                |
| listen_ipv6=YES                | Listen on IPv6?                                                                                           |
| anonymous_enable=NO           | Enable anonymous access?                                                                                  |
| local_enable=YES              | Allow local users to login?                                                                               |
| dirmessage_enable=YES         | Display active directory messages when users go into certain directories?                                 |
| use_localtime=YES             | Use local time?                                                                                           |
| xferlog_enable=YES            | Activate logging of uploads/downloads?                                                                    |
| connect_from_port_20=YES      | Connect from port 20?                                                                                     |
| secure_chroot_dir=/var/run/vsftpd/empty | Name of an empty directory                                                                 |
| pam_service_name=vsftpd       | This string is the name of the PAM service vsftpd will use.                                               |
| rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem | RSA certificate file used for SSL connections.                                |
| rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key | RSA private key file for SSL connections.                         |
| ssl_enable=NO                 | Enable SSL encrypted connections?                                                                         |


there is another file -- `/etc/ftpusers` this is used to deny certain users access to the FTP services

## Dangerous Settings
Security-related settings we can make on each servers

With the standard FTP client (ftp), we can access the FTP server accordingly and log in with the anonymous user if the settings shown above have been used. The use of the anonymous account can occur in internal environments and infrastructures where the participants are all known. 

connect to the vsFTPd server, the response `code 220`

ften this banner contains the description of the service and even the version of it. It also tells us what type of system the FTP server is. One of the most common configurations of FTP servers is to allow anonymous access, which does not require legitimate credentials but provides access to some files. 

**Anonymous Login**

```
NiteshKS22@htb[/htb]$ ftp 10.129.14.136

Connected to 10.129.14.136.
220 "Welcome to the HTB Academy vsFTP service."
Name (10.129.14.136:cry0l1t3): anonymous

230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.


ftp> ls

200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK.
```

Some commands should be used occasionally, as these will make the server show us more information that we can use for our purposes. These commands include `debug` and `trace`.

```
ftp> debug

Debugging on (debug=1).


ftp> trace

Packet tracing on.


ftp> ls

---> PORT 10,10,14,4,188,195
200 PORT command successful. Consider using PASV.
---> LIST
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK.
```

### 🔒 vsftpd Directory & User Access Settings

| Setting                  | Description                                                                 |
|--------------------------|-----------------------------------------------------------------------------|
| dirmessage_enable=YES    | Show a message when users first enter a new directory?                      |
| chown_uploads=YES        | Change ownership of anonymously uploaded files?                             |
| chown_username=username  | User who is given ownership of anonymously uploaded files.                  |
| local_enable=YES         | Enable local users to login?                                                |
| chroot_local_user=YES    | Place local users into their home directory?                                |
| chroot_list_enable=YES   | Use a list of local users that will be placed in their home directory?      |
| hide_ids=YES             | Display all user and group info in listings as "ftp".                       |
| ls_recurse_enable=YES    | Allows the use of recursive directory listings.                             |

, we can see that if the hide_ids=YES setting is present, the UID and GUID representation of the service will be overwritten, making it more difficult for us to identify with which rights these files are written and uploaded.
This setting is a security feature to prevent local usernames from being revealed. With the usernames, we could attack the services like FTP and SSH and many others with a brute-force attack in theory. 

However, in reality, [fail2ban](https://en.wikipedia.org/wiki/Fail2ban) solutions are now a standard implementation of any infrastructure that logs the IP address and blocks all access to the infrastructure after a certain number of failed login attempts.

Another helpful setting we can use for our purposes is the ls_recurse_enable=YES. This is often set on the vsFTPd server to have a better overview of the FTP directory structure, as it allows us to see all the visible content at once.

## Recursive Listing
```
ftp> ls -R

---> PORT 10,10,14,4,222,149
200 PORT command successful. Consider using PASV.
---> LIST -R
150 Here comes the directory listing.
.:
-rw-rw-r--    1 ftp      ftp      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 ftp      ftp           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 ftp      ftp            0 Sep 15 14:57 testupload.txt

./Clients:
drwx------    2 ftp      ftp          4096 Sep 16 18:04 HackTheBox
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:00 Inlanefreight

./Clients/HackTheBox:
-rw-r--r--    1 ftp      ftp         34872 Sep 16 18:04 appointments.xlsx
-rw-r--r--    1 ftp      ftp        498123 Sep 16 18:04 contract.docx
-rw-r--r--    1 ftp      ftp        478237 Sep 16 18:04 contract.pdf
-rw-r--r--    1 ftp      ftp           348 Sep 16 18:04 meetings.txt

./Clients/Inlanefreight:
-rw-r--r--    1 ftp      ftp         14211 Sep 16 18:00 appointments.xlsx
-rw-r--r--    1 ftp      ftp         37882 Sep 16 17:58 contract.docx
-rw-r--r--    1 ftp      ftp            89 Sep 16 17:58 meetings.txt
-rw-r--r--    1 ftp      ftp        483293 Sep 16 17:59 proposal.pptx

./Documents:
-rw-r--r--    1 ftp      ftp         23211 Sep 16 18:05 appointments-template.xlsx
-rw-r--r--    1 ftp      ftp         32521 Sep 16 18:05 contract-template.docx
-rw-r--r--    1 ftp      ftp        453312 Sep 16 18:05 contract-template.pdf

./Employees:
226 Directory send OK.
```


## Download All Available Files

```
NiteshKS22@htb[/htb]$ wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136

--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/                                         
           => ‘10.129.14.136/.listing’                                                                     
Connecting to 10.129.14.136:21... connected.                                                               
Logging in as anonymous ... Logged in!
==> SYST ... done.    ==> PWD ... done.
==> TYPE I ... done.  ==> CWD not needed.
==> PORT ... done.    ==> LIST ... done.                                                                 
12.12.1.136/.listing           [ <=>                                  ]     466  --.-KB/s    in 0s       
                                                                                                         
2021-09-19 14:45:58 (65,8 MB/s) - ‘10.129.14.136/.listing’ saved [466]                                     
--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/Calendar.pptx   
           => ‘10.129.14.136/Calendar.pptx’                                       
==> CWD not required.                                                           
==> SIZE Calendar.pptx ... done.                                                                                                                            
==> PORT ... done.    ==> RETR Calendar.pptx ... done.       

...SNIP...

2021-09-19 14:45:58 (48,3 MB/s) - ‘10.129.14.136/Employees/.listing’ saved [119]

FINISHED --2021-09-19 14:45:58--
Total wall clock time: 0,03s
Downloaded: 15 files, 1,7K in 0,001s (3,02 MB/s)
```


## Footprinting Service 

Footprinting using various network scanners is also a handy and widespread approach. These tools make it easier for us to identify different services, even if they are not accessible on standard ports. One of the most widely used tools for this purpose is Nmap. -- `NSE`

All the NSE scripts are located on the Pwnbox in /usr/share/nmap/scripts/, but on our systems, we can find them using a simple command.

The ftp-syst, for example, executes the STAT command, which displays information about the FTP server status. This includes configurations as well as the version of the FTP server. Nmap also provides the ability to trace the progress of NSE scripts at the network level if we use the --script-trace option in our scans. This lets us see what commands Nmap sends, what ports are used, and what responses we receive from the scanned server.

## Nmap Script Trace
```
NiteshKS22@htb[/htb]$ sudo nmap -sV -p21 -sC -A 10.129.14.136 --script-trace

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 13:54 CEST                                                                                                                                                   
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 8 [10.129.14.136:21]                                   
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 16 [10.129.14.136:21]             
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 24 [10.129.14.136:21]
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 32 [10.129.14.136:21]
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #1 [10.129.14.136:21] (timeout: 7000ms) EID 42
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #2 [10.129.14.136:21] (timeout: 9000ms) EID 50
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #3 [10.129.14.136:21] (timeout: 7000ms) EID 58
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #4 [10.129.14.136:21] (timeout: 11000ms) EID 66
NSE: TCP 10.10.14.4:54226 > 10.129.14.136:21 | CONNECT
NSE: TCP 10.10.14.4:54228 > 10.129.14.136:21 | CONNECT
NSE: TCP 10.10.14.4:54230 > 10.129.14.136:21 | CONNECT
NSE: TCP 10.10.14.4:54232 > 10.129.14.136:21 | CONNECT
NSOCK INFO [11.4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 50 [10.129.14.136:21] (41 bytes): 220 Welcome to HTB-Academy FTP service...
NSOCK INFO [11.4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 58 [10.129.14.136:21] (41 bytes): 220 Welcome to HTB-Academy FTP service...
NSE: TCP 10.10.14.4:54228 < 10.129.14.136:21 | 220 Welcome to HTB-Academy FTP service.
```

The scan history shows that four different parallel scans are running against the service, with various timeouts. For the NSE scripts, we see that our local machine uses other output ports (54226, 54228, 54230, 54232) and first initiates the connection with the CONNECT command. From the first response from the server, we can see that we are receiving the banner from the server to our second NSE script (54228) from the target FTP server. If necessary, we can, of course, use other applications such as netcat or telnet to interact with the FTP server.

## Service Interaction

```
nc -nc <target> 21
```

```
telnet <target> 21
```

It looks slightly different if the FTP server runs with TLS/SSL encryption. Because then we need a client that can handle TLS/SSL. For this, we can use the client openssl and communicate with the FTP server. The good thing about using openssl is that we can see the SSL certificate, which can also be helpful.

```
iteshKS22@htb[/htb]$ openssl s_client -connect 10.129.14.136:21 -starttls ftp

CONNECTED(00000003)                                                                                      
Can't use SSL_get_servername                        
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
verify error:num=18:self signed certificate
verify return:1

depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
verify return:1
---                                                 
Certificate chain
 0 s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
 
 i:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
---
 
Server certificate

-----BEGIN CERTIFICATE-----

MIIENTCCAx2gAwIBAgIUD+SlFZAWzX5yLs2q3ZcfdsRQqMYwDQYJKoZIhvcNAQEL
...SNIP...
```

This is because the SSL certificate allows us to recognize the hostname, for example, and in most cases also an email address for the organization or company. In addition, if the company has several locations worldwide, certificates can also be created for specific locations, which can also be identified using the SSL certificate.


## QUESTIONS

**1.  Which version of the FTP server is running on the target system? Submit the entire banner as the answer.**
<img width="953" height="361" alt="image" src="https://github.com/user-attachments/assets/f3fb472a-af32-402d-a4aa-d935d611294b" />

we get port 21 unfiltered

<img width="888" height="256" alt="image" src="https://github.com/user-attachments/assets/aa14f7ac-01e8-4439-8f6d-207820703ccb" />

use login anonymous and in password click enter(empty password)

we get FTP access

**2. Enumerate the FTP server and find the flag.txt file. Submit the contents of it as the answer.**

<img width="831" height="126" alt="image" src="https://github.com/user-attachments/assets/8677d0f5-cf0b-48c8-bf53-6cc64575c098" />

<img width="916" height="228" alt="image" src="https://github.com/user-attachments/assets/f9bf7eb2-b18d-4df2-9373-049d358b8ad2" />

<img width="764" height="154" alt="image" src="https://github.com/user-attachments/assets/142d6269-450e-4bab-87ed-55e8217e1b37" />




